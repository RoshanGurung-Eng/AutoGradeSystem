<!doctype html>
<html>
  <head>
    <title>Simple Grading Test</title>
    <style>
      body {
        font-family: Arial;
        max-width: 600px;
        margin: 50px auto;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .upload {
        border: 2px dashed #2196f3;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
      }
      .result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background: #e8f5e9;
        border: 1px solid #4caf50;
      }
      .error {
        background: #ffebee;
        border: 1px solid #f44336;
      }
      .score {
        font-size: 48px;
        font-weight: bold;
        color: #4caf50;
        text-align: center;
        margin: 20px 0;
      }
      .keywords {
        margin: 15px 0;
      }
      .matched {
        color: #4caf50;
      }
      .missing {
        color: #f44336;
      }
      button {
        background: #2196f3;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #0b7dda;
      }
      button:disabled {
        background: #9e9e9e;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìù Simple Grading Test</h1>
      <p>Upload any answer sheet - system will grade using UML keywords</p>

      <div
        class="upload"
        onclick="document.getElementById('fileInput').click()"
      >
        <p>üì∑ Click to upload answer image</p>
        <input
          type="file"
          id="fileInput"
          accept="image/*"
          style="display: none"
        />
      </div>

      <button onclick="uploadImage()" id="submitBtn">Grade Answer</button>

      <div class="result" id="resultBox"></div>
    </div>

    <!-- autograder/templates/autograder/simple_test.html -->
    <!-- Replace the script section with this: -->

    <script>
      let selectedFile = null;

      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          selectedFile = e.target.files[0];
          if (selectedFile) {
            document.querySelector(".upload p").textContent =
              "‚úÖ " + selectedFile.name;
          }
        });

      async function uploadImage() {
        if (!selectedFile) {
          alert("Please select an image first!");
          return;
        }

        const formData = new FormData();
        formData.append("image", selectedFile);

        const btn = document.getElementById("submitBtn");
        btn.disabled = true;
        btn.textContent = "Processing...";

        const resultBox = document.getElementById("resultBox");
        resultBox.style.display = "none";

        try {
          const response = await fetch("/grade/", {
            method: "POST",
            body: formData,
          });

          console.log("Response status:", response.status);
          console.log(
            "Response headers:",
            response.headers.get("content-type"),
          );

          // Check if response is HTML (error page)
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("text/html")) {
            const html = await response.text();
            console.error(
              "Server returned HTML instead of JSON:",
              html.substring(0, 500),
            );
            resultBox.className = "result error";
            resultBox.innerHTML = `<h2>‚ùå Server Error</h2><p>Server returned HTML page instead of JSON.</p><p>Status: ${response.status}</p><p>Check server console for details.</p>`;
            resultBox.style.display = "block";
            return;
          }

          const data = await response.json();
          console.log("Response data:", data);

          if (data.success) {
            resultBox.className = "result success";
            resultBox.innerHTML = `
                    <h2>‚úÖ Result</h2>
                    <div class="score">${data.grade}</div>
                    <div class="keywords">
                        <strong>Extracted Text:</strong><br>
                        <div style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin-top: 10px; max-height: 200px; overflow: auto;">
                            ${data.corrected_text || "No text extracted"}
                        </div>
                    </div>
                    <div class="keywords">
                        <strong>‚úÖ Matched Keywords (${data.matched ? data.matched.length : 0}):</strong><br>
                        <span class="matched">${data.matched ? data.matched.join(", ") : "None"}</span>
                    </div>
                    <div class="keywords">
                        <strong>‚ùå Missing Keywords (${data.missing ? data.missing.length : 0}):</strong><br>
                        <span class="missing">${data.missing ? data.missing.join(", ") : "None"}</span>
                    </div>
                `;
          } else {
            resultBox.className = "result error";
            resultBox.innerHTML = `
                    <h2>‚ùå Error</h2>
                    <p><strong>Message:</strong> ${data.error || "Unknown error"}</p>
                    ${data.traceback ? `<details><summary>Show Traceback</summary><pre>${data.traceback}</pre></details>` : ""}
                `;
          }

          resultBox.style.display = "block";
        } catch (error) {
          console.error("Fetch error:", error);
          resultBox.className = "result error";
          resultBox.innerHTML = `<h2>‚ùå Network Error</h2><p><strong>Error:</strong> ${error.message}</p><p>Check browser console (F12) for details.</p>`;
          resultBox.style.display = "block";
        } finally {
          btn.disabled = false;
          btn.textContent = "Grade Answer";
        }
      }
    </script>
  </body>
</html>
